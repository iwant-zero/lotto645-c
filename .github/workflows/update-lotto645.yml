name: Update Lotto645 Data

on:
  workflow_dispatch:
  schedule:
    # 매일 00:15 KST = 15:15 UTC
    - cron: "15 15 * * *"

permissions:
  contents: write
  issues: write

concurrency:
  group: update-lotto645
  cancel-in-progress: false

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Update JSON
        run: node scripts/update_lotto645.mjs

      - name: Auto commit
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore(data): update lotto645 draws & freq"
          file_pattern: "data/lotto645_draws.json data/lotto645_freq.json"

      - name: Alert issue if degraded
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require("fs");
            const p = "data/lotto645_freq.json";
            if (!fs.existsSync(p)) {
              core.warning("freq.json not found; skip alert");
              return;
            }
            const freq = JSON.parse(fs.readFileSync(p, "utf-8"));
            const health = freq?.health?.status || "unknown";
            const reasons = (freq?.health?.reasons || []).slice(0, 12).join(", ");
            const last = freq?.lastDraw?.drwNo;
            const upd = freq?.updatedAt;

            if (health === "ok") {
              console.log("Health OK. No issue.");
              return;
            }

            const title = "Lotto645 updater: DEGRADED";
            // check existing open issue
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: "open",
              per_page: 50
            });

            const existing = issues.find(it => it.title === title);
            const body =
              `업데이트 상태가 DEGRADED로 감지되었습니다.\n\n` +
              `- updatedAt: ${upd}\n` +
              `- lastDraw: ${last}\n` +
              `- reasons: ${reasons || "(none)"}\n\n` +
              `자동 생성 알림입니다. (스케줄 업데이트가 정상 복귀하면 이슈를 닫아도 됩니다.)`;

            if (existing) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existing.number,
                body
              });
              console.log("Commented on existing degraded issue.");
              return;
            }

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title,
              body
            });
            console.log("Created degraded issue.");
